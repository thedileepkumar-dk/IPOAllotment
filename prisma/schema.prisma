generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE MODELS
// ============================================================================

model IPO {
  id                Int       @id @default(autoincrement())
  name              String
  slug              String    @unique
  category          String    @default("Mainboard") // Mainboard, SME
  status            String    @default("Upcoming") // Upcoming, Live, Closed, Archived
  
  // Pricing
  issuePrice        Float?
  minPrice          Float?
  maxPrice          Float?
  lotSize           Int?
  
  // Dates
  openDate          DateTime?
  closeDate         DateTime?
  allotmentDate     DateTime?
  refundDate        DateTime?
  creditDate        DateTime?
  listingDate       DateTime?
  
  // Registrar
  registrarId       Int?
  registrar         Registrar? @relation(fields: [registrarId], references: [id])
  allotmentUrl      String?   // Direct URL fallback
  isAllotmentLive   Boolean   @default(false)
  
  // SEO Fields
  seoTitle          String?
  seoDescription    String?   @db.Text
  focusKeyword      String?
  secondaryKeywords String?   @db.Text // JSON array
  seoScore          Int       @default(0)
  schemaConfig      String?   @db.Text // JSON
  isIndexable       Boolean   @default(true)
  canonicalUrl      String?
  robotsMeta        String?   @default("index, follow")
  
  // Open Graph
  ogTitle           String?
  ogDescription     String?   @db.Text
  ogImage           String?
  
  // Metadata
  exchange          String?   // NSE, BSE
  issueSize         Float?
  about             String?   @db.LongText
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  allotmentChecks   AllotmentCheck[]
  
  @@index([status])
  @@index([allotmentDate])
  @@index([registrarId])
}

model Registrar {
  id                Int       @id @default(autoincrement())
  name              String    @unique
  slug              String    @unique
  
  // Configuration
  baseUrl           String
  endpointPattern   String    @db.Text
  requiredParams    String    @db.Text  // JSON array: ["pan", "appNo"]
  responseFormat    String    @default("html") // html, json
  parsingRules      String    @db.Text  // JSON object with selectors
  
  // Status
  isActive          Boolean   @default(true)
  lastTested        DateTime?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  ipos              IPO[]
  allotmentChecks   AllotmentCheck[]
  
  @@index([slug])
}

model AllotmentCheck {
  id          Int       @id @default(autoincrement())
  ipoId       Int
  registrarId Int
  status      String    // success, error, not_found, captcha, timeout
  errorType   String?
  checkedAt   DateTime  @default(now())
  
  // Relations (NO PAN or personal data stored!)
  ipo         IPO       @relation(fields: [ipoId], references: [id], onDelete: Cascade)
  registrar   Registrar @relation(fields: [registrarId], references: [id], onDelete: Cascade)
  
  @@index([ipoId])
  @@index([registrarId])
  @@index([checkedAt])
}

// ============================================================================
// ADMIN & SETTINGS
// ============================================================================

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
}

model SystemSetting {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String   @db.LongText
  category    String   @default("general") // general, seo, analytics, security
  description String?  @db.Text
  type        String   @default("text") // text, number, boolean, json
  updatedAt   DateTime @updatedAt
}

// ============================================================================
// CONTENT
// ============================================================================

model Page {
  id             Int       @id @default(autoincrement())
  title          String
  slug           String    @unique
  content        String    @db.LongText
  status         String    @default("published")
  
  // SEO
  seoTitle       String?
  seoDescription String?   @db.Text
  focusKeyword   String?
  seoScore       Int       @default(0)
  robotsMeta     String?   @default("index, follow")
  isIndexable    Boolean   @default(true)
  
  // Timestamps
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// ============================================================================
// SEO & REDIRECTS
// ============================================================================

model Redirect {
  id             Int      @id @default(autoincrement())
  sourceUrl      String   @unique
  destinationUrl String   @db.Text
  statusCode     Int      @default(301) // 301, 302, 307
  hits           Int      @default(0)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([sourceUrl])
}

model NotFoundLog {
  id        Int      @id @default(autoincrement())
  url       String
  userAgent String?  @db.Text
  ipHash    String?
  referrer  String?  @db.Text
  createdAt DateTime @default(now())
  
  @@index([url])
  @@index([createdAt])
}
